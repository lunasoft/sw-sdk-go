# SW SDK Go

SDK oficial de SW (Servicios Web) para Go que permite interactuar con los servicios.
 
**Versi√≥n:** 1.1.0  
**Licencia:** MIT  
**Desarrollador:** David Ernesto Reyes Ayala

## Caracter√≠sticas

- ‚úÖ **Autenticaci√≥n** - Gesti√≥n de tokens de acceso con soporte para token infinito
- ‚úÖ **Emisi√≥n (Issue)** - 4 versiones de respuesta (v1, v2, v3, v4)
- ‚úÖ **Timbrado (Stamp)** - 4 versiones de respuesta (v1, v2, v3, v4)
- ‚úÖ **Cancelaci√≥n** - 4 m√©todos de cancelaci√≥n (UUID, CSD, PFX, XML)
- ‚úÖ **Gesti√≥n de Usuarios** - Operaciones CRUD completas
- ‚úÖ **Gesti√≥n de Balance** - A√±adir, consultar y eliminar timbres
- ‚úÖ **Validaci√≥n CFDI** - Validar archivos XML de CFDI
- ‚úÖ **Consulta de Estatus** - Consultar estatus de CFDI en el SAT
- ‚úÖ **Variables de Entorno** - Configuraci√≥n segura mediante variables de entorno
- ‚úÖ **Manejo de errores** robusto
- ‚úÖ **Tests** completos para todas las funcionalidades

## Instalaci√≥n

```bash
go get github.com/lunasoft/sw-sdk-go
```

### Requisitos

- Go 1.21.0 o superior
- Acceso a los servicios de SW (test o producci√≥n)
- Credenciales v√°lidas o token infinito

## Configuraci√≥n

El SDK se configura autom√°ticamente usando **variables de entorno** o valores por defecto.

### üîß Variables de Entorno (Recomendado)

Crea un archivo `.env` en la ra√≠z de tu proyecto:

```bash
# URLs de los servicios
SW_BASE_URL=https://services.test.sw.com.mx
SW_API_BASE_URL=https://api.test.sw.com.mx

# Credenciales (opcional si usas token infinito)
SW_USER=tu-usuario@sw.com.mx
SW_PASSWORD=tu-password

# Token infinito (recomendado para producci√≥n)
SW_TOKEN=tu-token-infinito-aqui
```

### üìã Variables Disponibles

| Variable | Descripci√≥n | Valor por defecto |
|----------|-------------|-------------------|
| `SW_BASE_URL` | URL base para servicios CFDI | `https://services.test.sw.com.mx` |
| `SW_API_BASE_URL` | URL base para servicios Management | `https://api.test.sw.com.mx` |
| `SW_USER` | Usuario para autenticaci√≥n | (vac√≠o) |
| `SW_PASSWORD` | Contrase√±a para autenticaci√≥n | (vac√≠o) |
| `SW_TOKEN` | Token infinito/fijo | (vac√≠o) |

### üîÑ Configuraci√≥n Program√°tica

```go
import "sw-sdk-golang/swsdk"

// El SDK carga autom√°ticamente las variables de entorno
config := swsdk.LoadConfig()

// Tambi√©n puedes configurar program√°ticamente
config.User = "otro-usuario@sw.com.mx"
config.Token = "otro-token"
```

### üîë Sistema de Autenticaci√≥n

El SDK soporta **dos m√©todos de autenticaci√≥n**:

#### 1. **Token Infinito** (Recomendado para producci√≥n)
```go
import "sw-sdk-golang/swsdk/autenticacion"

// Usar token fijo/infinito
client := autenticacion.SetUserWithToken("tu-token-infinito")
```

#### 2. **Autenticaci√≥n Tradicional** (Fallback)
```go
import "sw-sdk-golang/swsdk/autenticacion"

// Usar usuario/contrase√±a (con fallback autom√°tico)
client := autenticacion.SetUser() // Usa config.Token si existe, sino usa User/Password
```

**Prioridad de autenticaci√≥n:**
1. Si `config.Token` est√° configurado ‚Üí Usa token infinito
2. Si `config.Token` est√° vac√≠o ‚Üí Usa autenticaci√≥n tradicional

## Inicio R√°pido

### Ejemplo b√°sico con token infinito

```go
package main

import (
    "fmt"
    "log"
    "sw-sdk-golang/swsdk/autenticacion"
    "sw-sdk-golang/swsdk/balance"
)

func main() {
    // Configurar cliente con token infinito
    client := autenticacion.SetUserWithToken("tu-token-infinito")
    
    // Consultar balance
    resp, err := balance.GetBalance()
    if err != nil {
        log.Fatal(err)
    }
    
    fmt.Printf("Timbres disponibles: %d\n", resp.Data.StampsBalance)
}
```

### Ejemplo con autenticaci√≥n tradicional

```go
package main

import (
    "fmt"
    "log"
    "sw-sdk-golang/swsdk/autenticacion"
    "sw-sdk-golang/swsdk/issue"
)

func main() {
    // Configurar cliente
    client := autenticacion.SetUser()
    
    // Autenticar
    token, err := client.Autenticacion()
    if err != nil {
        log.Fatal(err)
    }
    
    // Emitir CFDI
    resp, err := issue.IssueV4(client, "ruta/al/archivo.xml")
    if err != nil {
        log.Fatal(err)
    }
    
    fmt.Printf("CFDI emitido: %s\n", resp.Data.UUID)
}
```

### URLs y Endpoints

- **BaseURL**: `https://services.test.sw.com.mx` (para CFDI)
- **APIBaseURL**: `https://api.test.sw.com.mx` (para Management)

#### Endpoints disponibles:
- **Autenticaci√≥n**: `/security/authenticate`
- **Emisi√≥n**: `/cfdi33/issue`
- **Timbrado**: `/cfdi33/stamp`
- **Cancelaci√≥n**: `/cfdi33/cancel`
- **Usuarios**: `/management/v2/api/dealers/users`
- **Balance**: `/management/v2/api/users/balance`
- **Validaci√≥n**: `/validate/cfdi`

## Uso

### 1. Autenticaci√≥n

#### Con Token Infinito (Recomendado)
```go
import "sw-sdk-golang/swsdk/autenticacion"

// Usar token fijo/infinito
client := autenticacion.SetUserWithToken("tu-token-infinito")
// No necesitas llamar Autenticacion() - el token ya est√° listo
```

#### Con Autenticaci√≥n Tradicional
```go
import "sw-sdk-golang/swsdk/autenticacion"

client := autenticacion.SetUser()
token, err := client.Autenticacion()
if err != nil {
    log.Fatal(err)
}
```

#### Con Fallback Autom√°tico
```go
import "sw-sdk-golang/swsdk/autenticacion"

// Si config.Token est√° configurado, lo usa autom√°ticamente
// Si no, usa autenticaci√≥n tradicional
client := autenticacion.SetUser()
token, err := client.Autenticacion() // Usa el m√©todo apropiado
```

### 2. Emisi√≥n de CFDI

```go
import "sw-sdk-golang/swsdk/issue"

// Emisi√≥n v1 (solo TFD)
resp, err := issue.IssueV1(client, "ruta/al/archivo.xml")

// Emisi√≥n v2 (TFD + CFDI)
resp, err := issue.IssueV2(client, "ruta/al/archivo.xml")

// Emisi√≥n v3 (solo CFDI)
resp, err := issue.IssueV3(client, "ruta/al/archivo.xml")

// Emisi√≥n v4 (respuesta completa)
resp, err := issue.IssueV4(client, "ruta/al/archivo.xml")
```

### 3. Timbrado de CFDI

```go
import "sw-sdk-golang/swsdk/stamp"

// Timbrado v1 (solo TFD)
resp, err := stamp.StampV1(client, "ruta/al/archivo.xml")

// Timbrado v2 (TFD + CFDI)
resp, err := stamp.StampV2(client, "ruta/al/archivo.xml")

// Timbrado v3 (solo CFDI)
resp, err := stamp.StampV3(client, "ruta/al/archivo.xml")

// Timbrado v4 (respuesta completa)
resp, err := stamp.StampV4(client, "ruta/al/archivo.xml")
```

### 4. Cancelaci√≥n de CFDI

```go
import "sw-sdk-golang/swsdk/cancelacion"

// Cancelaci√≥n por UUID
resp, err := cancelacion.CancelacionPorUUID(client, "RFC", "UUID", "motivo")

// Cancelaci√≥n por CSD
request := &cancelacion.CancelacionCSDRequest{
    UUID:     "uuid-del-cfdi",
    Password: "password-del-certificado",
    RFC:      "RFC-del-emisor",
    Motivo:   "02",
    B64Cer:   "certificado-en-base64",
    B64Key:   "llave-privada-en-base64",
}
resp, err := cancelacion.CancelacionPorCSD(client, request)

// Cancelaci√≥n por PFX
request := &cancelacion.CancelacionPFXRequest{
    UUID:     "uuid-del-cfdi",
    Password: "password-del-pfx",
    RFC:      "RFC-del-emisor",
    Motivo:   "02",
    B64Pfx:   "archivo-pfx-en-base64",
}
resp, err := cancelacion.CancelacionPorPFX(client, request)

// Cancelaci√≥n por XML
resp, err := cancelacion.CancelacionPorXML(client, "ruta/al/xml-de-cancelacion.xml")
```

### 5. Gesti√≥n de Usuarios

```go
import "sw-sdk-golang/swsdk/usuarios"

// Crear usuario
request := &usuarios.CreateUserRequest{
    Name:              "Nombre del Usuario",
    TaxID:             "RFC123456789",
    Email:             "usuario@ejemplo.com",
    Stamps:            100,
    IsUnlimited:       false,
    Password:          "Password123!",
    NotificationEmail: "notificaciones@ejemplo.com",
    Phone:             "1234567890",
}
resp, err := usuarios.CrearUsuario(client, request)

// Listar usuarios
params := &usuarios.ListUsersParams{
    IsActive: &[]bool{true}[0],
    Page:     &[]int{1}[0],
    PerPage:  &[]int{10}[0],
}
resp, err := usuarios.ListarUsuarios(client, params)

// Actualizar usuario
request := &usuarios.UpdateUserRequest{
    IDUser:            "id-del-usuario",
    NotificationEmail: &[]string{"nuevo@email.com"}[0],
    Phone:             &[]string{"9876543210"}[0],
}
resp, err := usuarios.ActualizarUsuario(client, "id-del-usuario", request)

// Eliminar usuario
err := usuarios.EliminarUsuario(client, "id-del-usuario")
```

### 6. Gesti√≥n de Balance (Timbres)

```go
import "sw-sdk-golang/swsdk/balance"

// A√±adir timbres a un usuario
resp, err := balance.AddStamps("user-id", 10, "Se abonan 10 timbres")
if err != nil {
    log.Fatal(err)
}
fmt.Printf("Total de timbres despu√©s del abono: %d\n", resp.Data)

// Consultar balance de timbres
resp, err := balance.GetBalance()
if err != nil {
    log.Fatal(err)
}
fmt.Printf("Timbres disponibles: %d\n", resp.Data.StampsBalance)
fmt.Printf("Timbres usados: %d\n", resp.Data.StampsUsed)
fmt.Printf("Timbres asignados: %d\n", resp.Data.StampsAssigned)

// Eliminar timbres de un usuario
resp, err := balance.RemoveStamps("user-id", 5, "Se retiran 5 timbres")
if err != nil {
    log.Fatal(err)
}
fmt.Printf("Total de timbres despu√©s de la eliminaci√≥n: %d\n", resp.Data)
```

### 7. Validaci√≥n CFDI

```go
import "sw-sdk-golang/swsdk/validacion"

// Validar un archivo XML de CFDI
resp, err := validacion.ValidarCFDI("ruta/al/archivo.xml")
if err != nil {
    log.Fatal(err)
}

// Imprimir resultado de forma legible
validacion.PrintValidacionResult(resp)

// Verificar si el CFDI es v√°lido
if validacion.IsValidCFDI(resp) {
    fmt.Println("CFDI es v√°lido")
} else {
    fmt.Println("CFDI tiene errores")
}

// Verificar si hay errores
if validacion.HasErrors(resp) {
    errors := validacion.GetErrors(resp)
    for _, err := range errors {
        fmt.Printf("Error: %s\n", err)
    }
}
```

## Estructura del Proyecto

```
sw-sdk-golang/
‚îú‚îÄ‚îÄ swsdk/
‚îÇ   ‚îú‚îÄ‚îÄ autenticacion/     # Gesti√≥n de autenticaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ issue/            # Emisi√≥n de CFDI
‚îÇ   ‚îú‚îÄ‚îÄ stamp/            # Timbrado de CFDI
‚îÇ   ‚îú‚îÄ‚îÄ cancelacion/      # Cancelaci√≥n de CFDI
‚îÇ   ‚îú‚îÄ‚îÄ usuarios/         # Gesti√≥n de usuarios
‚îÇ   ‚îú‚îÄ‚îÄ balance/          # Gesti√≥n de balance/timbres
‚îÇ   ‚îú‚îÄ‚îÄ validacion/       # Validaci√≥n de CFDI
‚îÇ   ‚îî‚îÄ‚îÄ config.go         # Configuraci√≥n del SDK
‚îú‚îÄ‚îÄ cmd/
‚îÇ   ‚îî‚îÄ‚îÄ main.go           # Ejemplo de uso
‚îú‚îÄ‚îÄ extras/               # Archivos de prueba
‚îî‚îÄ‚îÄ README.md
```

## Testing

Ejecutar todas las pruebas:

```bash
go test ./...
```

Ejecutar pruebas espec√≠ficas:

```bash
# Solo emisi√≥n
go test ./swsdk/issue -v

# Solo timbrado
go test ./swsdk/stamp -v

# Solo cancelaci√≥n
go test ./swsdk/cancelacion -v

# Solo usuarios
go test ./swsdk/usuarios -v

# Solo balance
go test ./swsdk/balance -v

# Solo validaci√≥n
go test ./swsdk/validacion -v
```

### Notas sobre las pruebas

- Las pruebas de **emisi√≥n** y **timbrado** requieren XML sellado v√°lido
- Las pruebas de **cancelaci√≥n** requieren certificados v√°lidos
- Las pruebas de **usuarios** tienen algunos tests con `t.Skip()` por restricciones del API
- Las pruebas de **balance** funcionan correctamente y muestran informaci√≥n detallada
- Las pruebas de **validaci√≥n** funcionan correctamente con archivos XML reales
- Para skipear pruebas problem√°ticas: `go test -skip`

## Requisitos

- Go 1.19 o superior
- Acceso a los servicios de SW (credenciales v√°lidas)

## Licencia

Este proyecto est√° bajo la licencia MIT. Ver el archivo LICENSE para m√°s detalles.

## Troubleshooting

### Problemas comunes

**Error de autenticaci√≥n:**
```go
// Verificar variables de entorno
config := swsdk.LoadConfig()
if config.Token == "" && config.User == "" {
    // Configurar variables de entorno o usar configuraci√≥n program√°tica
    config.User = "tu-usuario@sw.com.mx"
    config.Password = "tu-password"
    // O configurar token infinito
    config.Token = "tu-token-infinito"
}
```

**Variables de entorno no cargan:**
- Verificar que el archivo `.env` est√© en la ra√≠z del proyecto
- Verificar que las variables est√©n configuradas en el sistema
- Usar configuraci√≥n program√°tica como fallback

**Error de conexi√≥n:**
- Verificar conectividad a internet
- Verificar que las URLs est√©n correctas
- Verificar que las credenciales sean v√°lidas

**Error de validaci√≥n CFDI:**
- Verificar que el archivo XML existe
- Verificar que el archivo sea un CFDI v√°lido
- Verificar permisos de lectura del archivo

### Logs y debugging

```go
// Habilitar logs detallados
import "log"

// En caso de error, revisar el mensaje completo
if err != nil {
    log.Printf("Error detallado: %+v", err)
}
```

## Soporte

**Desarrollador:** David Ernesto Reyes Ayala  
**Email:** david.reyes@sw.com.mx  
**GitHub:** [david-reyes/sw-sdk-golang](https://github.com/david-reyes/sw-sdk-golang)

Para soporte t√©cnico o reportar bugs:
1. Revisar la secci√≥n de Troubleshooting
2. Crear un issue en GitHub
3. Contactar al desarrollador

## Changelog

### v1.1.0 (2025-01-04)
- üîë **NUEVO**: Sistema de Token Infinito
  - Soporte para tokens fijos/infinitos
  - Fallback autom√°tico a autenticaci√≥n tradicional
  - Funci√≥n `SetUserWithToken()` para tokens fijos
  - Prioridad: Token infinito > Autenticaci√≥n tradicional
- üîß **NUEVO**: Variables de Entorno
  - Configuraci√≥n segura sin credenciales hardcodeadas
  - Soporte para archivo `.env`
  - Variables: `SW_USER`, `SW_PASSWORD`, `SW_TOKEN`, `SW_BASE_URL`, `SW_API_BASE_URL`
- ‚úÖ Mejoras en configuraci√≥n
- ‚úÖ Tests actualizados para token infinito
- ‚úÖ Documentaci√≥n actualizada

### v1.0.0
- ‚úÖ Implementaci√≥n inicial del SDK
- ‚úÖ Soporte para emisi√≥n, timbrado, cancelaci√≥n y gesti√≥n de usuarios
- ‚úÖ Gesti√≥n de balance/timbres
- ‚úÖ Validaci√≥n de CFDI
- ‚úÖ Tests completos
- ‚úÖ Documentaci√≥n completa
